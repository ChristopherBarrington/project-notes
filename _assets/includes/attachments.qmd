<!-- include attachments, if `babs.attachments: true` is in the metadata -->

```{r appendix-attachments}
#| echo: false
#| eval: !expr purrr::pluck(rmarkdown::metadata, 'babs', 'attachments') |> is.null() |> magrittr::not()
#| results: asis

cat('## Attachments {.appendix}\n\n')

## ---- copy-targets

copy_target <- function(x) {
	report_path <- knitr::opts_knit$get('output.dir')
	analysis_path <- knitr::opts_knit$get('root.dir')

	files_path <- file.path(report_path, 'files')
	dir.create(path=files_path, showWarnings=FALSE, recursive=TRUE)

	stringr::str_glue('cp --recursive --parents --dereference {x} {files_path}') |> system()
}

purrr::pluck(rmarkdown::metadata, 'babs', 'attachments', .default=list()) |>
	plyr::l_ply(copy_target)

## ---- attach-targets

knitr::opts_knit$get('output.dir') |>
	file.path('files') |>
	list.files(recursive=TRUE) -> files

chunk_output <- 'No attachments to list.'
if(length(files) > 0)
	files |> (\(x) sprintf(fmt="{{< fa paperclip >}} [%s](files/%s)", x, x))() -> chunk_output
cat(chunk_output, sep="</br>")
```
